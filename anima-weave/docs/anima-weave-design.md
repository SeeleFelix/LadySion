# Anima Weave DSL 设计文档

## 📋 概述

本文档定义了Anima
Weave双流系统的领域特定语言(DSL)设计，建立了DSL语法与数学形式化定义的完整对应关系，并明确了三层架构中各层的职责分工。

## 🎯 设计目标

- **数学完备性**：DSL完整对应32个数学定义
- **语法简洁性**：保持用户友好的简洁语法
- **模块化支持**：支持子图封装和重用
- **语义标签安全性**：编译时语义标签检查和约束验证

---

## 📐 数学定义映射架构

### 🏗️ 三层处理架构

| 层次              | 职责       | 处理内容           |
| ----------------- | ---------- | ------------------ |
| **🔤 DSL语法层**  | 声明式表达 | 用户可见的语法结构 |
| **🔍 DSL检查层**  | 静态验证   | 编译时检查和推算   |
| **🦀 Rust引擎层** | 运行时执行 | 动态语义实现       |

### 📊 32个数学定义分层处理表

#### **基础语义标签系统 (定义1-4)**

| 定义 | 概念           | DSL语法                   | DSL检查        | Rust引擎     |
| ---- | -------------- | ------------------------- | -------------- | ------------ |
| 1    | 语义标签集合 ℒ | `-- semantic_labels` 段定义 | 语义标签注册和索引 | 语义标签系统实现 |
| 2    | 控制信号语义标签 𝒞 | `Signal`                  | 信号语义标签验证   | 信号传播实现 |
| 3    | 端口定义       | `a int`, `execute Signal` | 端口语义标签绑定   | 端口值管理   |
| 4    | 语义标签兼容性 Γ   | `int { double }`          | 兼容性图构建   | 语义标签转换实现 |

#### **节点系统 (定义5-6)**

| 定义 | 概念           | DSL语法                              | DSL检查      | Rust引擎     |
| ---- | -------------- | ------------------------------------ | ------------ | ------------ |
| 5    | 节点七元组     | `Add { mode Concurrent in{} out{} }` | 节点结构验证 | 节点实例管理 |
| 6    | 节点计算函数 φ | ❌ 不体现                            | ❌ 不处理    | ✅ 完整实现  |

#### **连接系统 (定义7-8)**

| 定义 | 概念           | DSL语法                        | DSL检查        | Rust引擎   |
| ---- | -------------- | ------------------------------ | -------------- | ---------- |
| 7    | 数据连接集合 𝒟 | `datas { a.x -> b.y }`         | 连接有效性检查 | 数据流传播 |
| 8    | 控制连接集合 ℰ | `controls { a.sig -> b.exec }` | 连接有效性检查 | 控制流传播 |

#### **图结构 (定义9-15)**

| 定义 | 概念               | DSL语法              | DSL检查             | Rust引擎      |
| ---- | ------------------ | -------------------- | ------------------- | ------------- |
| 9    | 节点集合 𝒩         | `nodes { add1 Add }` | 节点实例索引        | 节点生命周期  |
| 10   | AnimaWeave图三元组 | `-- graph` 结构      | 图结构验证          | 图执行调度    |
| 11   | 连接有效性约束     | ❌ 不体现            | ✅ 端口语义标签匹配检查 | ❌ 静态验证   |
| 12   | 图边界端口         | ❌ 不体现            | ✅ 边界端口自动推算 | ❌ 静态计算   |
| 13   | 必选端口DAG约束    | ❌ 不体现            | ✅ 循环检测算法     | ❌ 静态验证   |
| 14   | 输出端口不可变性   | ❌ 不体现            | ❌ 不处理           | ✅ 运行时约束 |
| 15   | 节点执行唯一性     | ❌ 不体现            | ❌ 不处理           | ✅ 运行时约束 |

#### **执行语义 (定义16-24)**

| 定义  | 概念               | DSL语法                      | DSL检查       | Rust引擎      |
| ----- | ------------------ | ---------------------------- | ------------- | ------------- |
| 16    | 双流AnimaWeave系统 | ✅ 整个DSL体现               | ✅ 完整性检查 | ✅ 系统实例化 |
| 17-18 | 执行状态空间       | ❌ 不体现                    | ❌ 不处理     | ✅ 状态管理   |
| 19    | 控制模式与激活谓词 | `mode=AND/OR/XOR`            | 模式配置验证  | 激活逻辑实现  |
| 20    | 数据就绪谓词       | `optional` 标记              | 可选端口识别  | 就绪状态判断  |
| 21-24 | 执行条件与转换     | `mode Sequential/Concurrent` | 并发配置验证  | 执行语义实现  |

#### **子图系统 (定义25-28)**

| 定义 | 概念           | DSL语法                   | DSL检查         | Rust引擎     |
| ---- | -------------- | ------------------------- | --------------- | ------------ |
| 25   | 子图关系       | `.graph.anima` 文件       | 子图导入解析    | 子图实例化   |
| 26   | 子图可封装条件 | ❌ 不体现                 | ✅ 封装条件验证 | ❌ 静态验证  |
| 27   | 子图-节点同构  | `double1 add_twice`       | 同构映射构建    | 同构执行     |
| 28   | 控制端口扩展   | `execute Signal mode=AND` | 激活模式解析    | 端口扩展实现 |

#### **信号传播 (定义29-32)**

| 定义  | 概念         | DSL语法   | DSL检查   | Rust引擎        |
| ----- | ------------ | --------- | --------- | --------------- |
| 29-32 | 信号传播机制 | ❌ 不体现 | ❌ 不处理 | ✅ 信号传播引擎 |

---

## 📝 DSL语法规范

[DSL 语法规范](./dsl-syntax-reference.md)

---

## 🔍 DSL检查层职责

### 1. 语义标签兼容性检查 (定义11)

验证连接两端的端口语义标签是否兼容，支持基于语义标签兼容性关系的递归查找。

### 2. 边界端口自动推算 (定义12)

根据数学定义自动计算图的边界端口：

- **数据输入边界**：没有连接来源的数据输入端口
- **数据输出边界**：没有连接目标的数据输出端口
- **控制输入边界**：没有连接来源的控制输入端口
- **控制输出边界**：没有连接目标的控制输出端口

### 3. DAG循环检测 (定义13)

构建必选端口依赖图，通过拓扑排序检测是否存在循环依赖。

### 4. 子图封装验证 (定义26)

验证子图是否满足封装条件：

- **边界端口完整性**：至少有一个边界端口
- **内部连通性**：图内所有节点可达
- **边界端口唯一性**：边界端口名称无重复

### 5. 节点结构验证

验证节点定义的完整性和一致性，包括端口定义、模式配置等。

### 6. 导入依赖解析

处理模块导入关系，构建依赖图，验证循环依赖。

---

## 🦀 Rust引擎层职责

### 1. 运行时状态管理

- **全局执行状态** (定义17)：维护数据状态、控制状态、节点状态
- **状态转换** (定义24)：根据节点执行更新全局状态
- **并发控制** (定义22)：管理节点的并发执行

### 2. 节点计算函数实现

- **计算函数φ** (定义6)：实现具体的节点计算逻辑
- **语义标签转换**：根据兼容性关系实现自动语义标签转换
- **端口值管理**：处理端口的读写操作

### 3. 信号传播引擎

- **信号传输** (定义29)：实现控制信号的传播机制
- **端口值计算** (定义30)：根据激活模式计算控制端口值
- **激活谓词评估** (定义21)：判断节点的控制激活状态

### 4. 执行约束实现

- **输出不可变性** (定义14)：确保已完成节点的输出不被修改
- **执行唯一性** (定义15)：保证节点在任意时刻最多有一个运行实例
- **就绪条件判断** (定义20-22)：综合判断节点是否可以执行

### 5. 子图同构执行

- **子图实例化** (定义27)：将子图作为节点进行实例化
- **边界映射**：建立子图边界端口与外部连接的映射关系
- **嵌套执行**：处理子图内部的执行调度

---

## 🎯 设计优势

### ✅ 数学完备性

DSL完整对应了AnimaWeave数学形式化定义的32个概念，确保了理论与实现的一致性。

### ✅ 分层架构清晰

三层架构职责明确，实现了关注点分离：

- **语法层**：简洁易用的用户界面
- **检查层**：编译时错误发现和性能优化
- **引擎层**：高效的运行时执行

### ✅ 模块化设计

子图系统支持层次化的模块组合，提供了良好的代码重用和系统组织能力。

### ✅ 语义标签安全

编译时的语义标签检查和约束验证，大大减少了运行时错误的可能性。

### ✅ 自动推算

边界端口、DAG约束等复杂概念通过自动推算实现，降低了用户的心智负担。

---

## 📚 相关文档

- [AnimaWeave数学形式化定义](./nodeflow-mathematica-definition.md)
