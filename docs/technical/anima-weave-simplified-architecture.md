# AnimaWeave ç®€åŒ–æ¶æ„è®¾è®¡

## ğŸ“‹ æ¦‚è¿°

ç»è¿‡ DataBus åˆå¹¶é‡æ„ï¼ŒAnimaWeave çš„æ¶æ„å¾—åˆ°äº†æ˜¾è‘—ç®€åŒ–ã€‚åŸæœ¬çš„ä¸‰å±‚æ¶æ„ï¼ˆCoordinator + DataBus + NodeActorï¼‰ç°åœ¨ç®€åŒ–ä¸ºä¸¤å±‚æ¶æ„ï¼ˆCoordinator + NodeActorï¼‰ï¼Œæ¶ˆé™¤äº†ç»„ä»¶é—´çš„èŒè´£é‡å ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€‚

## ğŸ—ï¸ æ¶æ„ç»„ä»¶

### 1. Coordinatorï¼ˆåè°ƒå™¨ï¼‰
**èŒè´£ï¼š**
- å›¾æ‰§è¡Œè°ƒåº¦å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ•°æ®æµç®¡ç†å’Œä¾èµ–æ£€æŸ¥
- æ§åˆ¶ä¿¡å·èšåˆå’Œè®¡ç®—
- èŠ‚ç‚¹å°±ç»ªåˆ¤æ–­å’Œæ´¾å‘

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- é›†æˆäº†åŸ DataBus çš„æ‰€æœ‰åŠŸèƒ½
- ä½¿ç”¨ ExecutionTracker å®ç°ä¸¥æ ¼é˜Ÿé¦–é˜»å¡è°ƒåº¦
- å†…ç½® DataStore ç®¡ç†æ•°æ®å’Œæ§åˆ¶ä¿¡å·
- è‡ªåŠ¨æ£€æµ‹å›¾å®ŒæˆçŠ¶æ€

### 2. NodeActorï¼ˆèŠ‚ç‚¹æ‰§è¡Œå™¨ï¼‰
**èŒè´£ï¼š**
- æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘
- å¤„ç†è¾“å…¥æ•°æ®å’Œäº§ç”Ÿè¾“å‡ºæ•°æ®
- å‘ Coordinator æŠ¥å‘Šæ‰§è¡ŒçŠ¶æ€

**å®ç°ï¼š**
- ä½¿ç”¨ PrimitiveNodeActor æ‰¿è½½ NodeFunction
- æ‰€æœ‰äº‹ä»¶ï¼ˆNodeOutputEventã€NodeExecutionEventï¼‰éƒ½å‘é€ç»™ Coordinator
- ä¸å†ä¸ DataBus ç›´æ¥é€šä¿¡

### 3. GraphLauncherï¼ˆå›¾å¯åŠ¨å™¨ï¼‰
**èŒè´£ï¼š**
- æœåŠ¡å…¥å£ç‚¹å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- è§£æ .weave æ–‡ä»¶å¹¶åˆ›å»ºå›¾å¯¹è±¡
- åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶å¹¶å»ºç«‹è¿æ¥
- å¾ªç¯å¤„ç†å›¾æ‰§è¡Œè¯·æ±‚

## ğŸ”„ äº‹ä»¶æµç¨‹

### ç®€åŒ–åçš„äº‹ä»¶æµï¼š
```
NodeActor â†’ Coordinator â†’ NodeActor
    â†“         â†“
    â†“      ExecutionTracker
    â†“         â†“
    â†“      DataStore
    â†“         â†“
    â†“      è°ƒåº¦å†³ç­–
    â†“         â†“
    â†“      æ´¾å‘æ‰§è¡Œ
    â†“         â†“
    â†“      ä¾èµ–æ£€æŸ¥
    â†“         â†“
    â†“      å›¾å®Œæˆæ£€æµ‹
```

### å…³é”®äº‹ä»¶ï¼š
1. **NodeOutputEvent**ï¼šNodeActor â†’ Coordinator
2. **NodeExecutionEvent**ï¼šNodeActor â†’ Coordinator
3. **NodeExecuteEvent**ï¼šCoordinator â†’ NodeActor
4. **NodeReadyEvent**ï¼šCoordinator å†…éƒ¨å¤„ç†

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. æ¶æ„ç®€åŒ–
- ä»ä¸‰å±‚æ¶æ„ç®€åŒ–ä¸ºä¸¤å±‚æ¶æ„
- æ¶ˆé™¤äº† DataBus å’Œ Coordinator é—´çš„èŒè´£é‡å 
- å‡å°‘äº†ç»„ä»¶é—´çš„é€šä¿¡å¼€é”€

### 2. èŒè´£æ¸…æ™°
- Coordinatorï¼šå…¨æƒè´Ÿè´£è°ƒåº¦å’Œæ•°æ®æµç®¡ç†
- NodeActorï¼šä¸“æ³¨äºä¸šåŠ¡é€»è¾‘æ‰§è¡Œ
- æ¯ä¸ªç»„ä»¶éƒ½æœ‰æ˜ç¡®çš„å•ä¸€èŒè´£

### 3. æ€§èƒ½æå‡
- å‡å°‘äº†ä¸€å±‚æ¶ˆæ¯ä¼ é€’
- å†…éƒ¨å‡½æ•°è°ƒç”¨æ›¿ä»£äº†å¼‚æ­¥æ¶ˆæ¯
- é™ä½äº†ç³»ç»Ÿçš„æ•´ä½“å»¶è¿Ÿ

### 4. æ˜“äºç»´æŠ¤
- ä»£ç é‡å¤å¤§å¹…å‡å°‘
- è°ƒè¯•å’Œè¿½è¸ªæ›´åŠ ç®€å•
- é”™è¯¯å¤„ç†æ›´åŠ é›†ä¸­

## ğŸ”§ æŠ€æœ¯å®ç°

### ExecutionTracker ä¸¥æ ¼é˜Ÿé¦–é˜»å¡è°ƒåº¦
```rust
pub fn try_dispatch_next(&mut self) -> Option<NodeExecuteEvent> {
    // 1. æ£€æŸ¥å…¨å±€ä¸²è¡Œé”
    if self.is_sequential_running {
        return None;
    }
    
    // 2. æ£€æŸ¥é˜Ÿåˆ—å¤´éƒ¨
    let Some(execution_id) = self.pending_ids.front() else {
        return None;
    };
    
    // 3. åº”ç”¨å¹¶å‘è§„åˆ™
    // ...
}
```

### ç»Ÿä¸€çš„æ•°æ®æµå¤„ç†
```rust
pub(crate) fn handle_node_output(&mut self, event: NodeOutputEvent) {
    // 1. è®°å½•æ•°æ®åˆ° DataStore
    self.record_outputs(&event);
    
    // 2. æ£€æŸ¥ä¸‹æ¸¸èŠ‚ç‚¹å°±ç»ªçŠ¶æ€
    self.process_ready_nodes(&event.node_name);
    
    // 3. æ£€æŸ¥å›¾å®ŒæˆçŠ¶æ€
    if self.is_graph_execution_completed() {
        self.emit_graph_completed();
    }
}
```

## ğŸš€ æœåŠ¡åŒ–è®¾è®¡

### GraphLauncher æœåŠ¡å¾ªç¯
```rust
pub async fn run_service_loop(&mut self) {
    loop {
        // 1. æ¥æ”¶ .weave æ–‡ä»¶
        let weave_file = self.receive_weave_file().await;
        
        // 2. è§£æå¹¶æ‰§è¡Œå›¾
        let result = self.execute_graph(weave_file).await;
        
        // 3. è¾“å‡ºç»“æœ
        self.output_result(result).await;
        
        // 4. ç­‰å¾…ä¸‹ä¸€ä¸ªè¯·æ±‚
    }
}
```

## ğŸ“Š ä¸åŸæ¶æ„å¯¹æ¯”

| æ–¹é¢ | åŸæ¶æ„ | ç®€åŒ–æ¶æ„ |
|------|--------|----------|
| ç»„ä»¶æ•°é‡ | 3å±‚ï¼ˆCoordinator + DataBus + NodeActorï¼‰ | 2å±‚ï¼ˆCoordinator + NodeActorï¼‰ |
| æ¶ˆæ¯è·¯å¾„ | NodeActor â†’ DataBus â†’ Coordinator | NodeActor â†’ Coordinator |
| èŒè´£åˆ†ç¦» | éƒ¨åˆ†é‡å  | å®Œå…¨åˆ†ç¦» |
| ä»£ç é‡å¤ | è¾ƒå¤š | æå°‘ |
| è°ƒè¯•éš¾åº¦ | è¾ƒé«˜ | è¾ƒä½ |
| æ€§èƒ½å¼€é”€ | è¾ƒé«˜ | è¾ƒä½ |

## ğŸ”„ è¿ç§»å½±å“

### å·²å®Œæˆçš„é‡æ„ï¼š
- âœ… ç§»é™¤ DataBus actor å®ç°
- âœ… åˆå¹¶ DataBus åŠŸèƒ½åˆ° Coordinator
- âœ… æ›´æ–° NodeActor äº‹ä»¶å‘é€ç›®æ ‡
- âœ… ç®€åŒ– GraphLauncher åˆå§‹åŒ–æµç¨‹
- âœ… æ›´æ–°ç›¸å…³äº‹ä»¶æ–‡æ¡£

### å‘åå…¼å®¹æ€§ï¼š
- ä¿æŒäº†æ‰€æœ‰æ ¸å¿ƒæ¥å£ä¸å˜
- äº‹ä»¶ç±»å‹å®šä¹‰ä¿æŒå…¼å®¹
- å¯¹å¤–éƒ¨ä½¿ç”¨è€…é€æ˜

## ğŸ¯ æœªæ¥è§„åˆ’

### çŸ­æœŸç›®æ ‡ï¼š
1. å®Œå–„å›¾å®Œæˆæ£€æµ‹æœºåˆ¶
2. æ·»åŠ æ›´è¯¦ç»†çš„æ‰§è¡Œç»Ÿè®¡
3. ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œæ¢å¤

### é•¿æœŸç›®æ ‡ï¼š
1. æ”¯æŒåŠ¨æ€å›¾ä¿®æ”¹
2. å¢åŠ åˆ†å¸ƒå¼æ‰§è¡Œèƒ½åŠ›
3. å®ç°æ›´æ™ºèƒ½çš„è°ƒåº¦ç®—æ³•

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ExecutionTracker è®¾è®¡æ–‡æ¡£](./anima-weave-actor-model-design.md)
- [å›¾æ‰§è¡Œæµç¨‹](../architecture/animaweave-class-diagram.md)
- [äº‹ä»¶ç³»ç»Ÿè®¾è®¡](../architecture/backend.md)

---

*æ›´æ–°æ—¶é—´ï¼š2024-12-24*
*ç‰ˆæœ¬ï¼šç®€åŒ–æ¶æ„ v1.0* 